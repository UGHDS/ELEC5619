<!doctype html>
<html>
<head>
    <link href="../css/styles.css" rel="stylesheet" />
    <head th:include="fragments/headerLogged :: head"></head>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-timepicker/1.3.5/jquery.timepicker.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Userhome Organizer</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@0.21.4/dist/axios.min.js"></script>
</head>
<body>
<!--引入 templates/fragments/header.html中的navbar-->
<nav th:replace="fragments/headerLogged :: navbar"></nav>

<!--这部分是你要写的部分-->
<div id="app">
    <span class="userHomeTitle">Welcome Back, {{ welcome.first_name }} {{ welcome.last_name }}</span>

    <div class="frameContainer">

        <div class="tab">
            <button class="tablinks" :class="{ active: currentTab === 'VenueInformation' }" @click="changeTab('VenueInformation')" style="width:33.3%; border-radius: 20px 0px 0px 0px" >Venue Information</button>
            <button class="tablinks" :class="{ active: currentTab === 'PhotoGallery' }" @click="changeTab('PhotoGallery')" style="width:33.3%">Photo Gallery</button>
            <button class="tablinks" :class="{ active: currentTab === 'StallInformation' }" @click="changeTab('StallInformation')" style="width:33.4%; border-radius: 0px 20px 0px 0px">Stall Management</button>
        </div>

        <!-- Tab content -->
        <div v-show="currentTab === 'VenueInformation'" class="tabcontent">

            <form action="#" class="marketForm">
                <label>Venue Name:</label>
                <input type="text" value="Fairfield Markets" name="venueName" id="venueName" style="width:87.8%; margin-left: 10px" required />

                <label>Address: </label>
                <input type="text" id="addressInput"  placeholder="Enter an address" name="addressM" />

<!--                <label>Start Date:</label>-->
<!--                <input type="date" id="datePickerS" name="datePickerS" value="2023-10-10" style="width:12%; margin-left: 10px" required>-->

<!--                <label>- End Date:</label>-->
<!--                <input type="date" id="datePickerE" name="datePickerE" value="2023-12-10" style="width:12%; margin-left: 10px" required>-->

<!--                <label style="margin-left: 50px"><input type="checkbox" name="weekday" value="Monday"> Mon</label>-->
<!--                <label style="margin-left: 5px"><input type="checkbox" name="weekday" value="Tuesday"> Tue</label>-->
<!--                <label style="margin-left: 5px"><input type="checkbox" name="weekday" value="Wednesday"> Wed</label>-->
<!--                <label style="margin-left: 5px"><input type="checkbox" name="weekday" value="Thursday"> Thu</label>-->
<!--                <label style="margin-left: 5px"><input type="checkbox" name="weekday" value="Friday"> Fri</label>-->
<!--                <label style="margin-left: 5px"><input type="checkbox" name="weekday" value="Saturday" checked> Sat</label>-->
<!--                <label style="margin-left: 5px"><input type="checkbox" name="weekday" value="Sunday"> Sun</label>-->

<!--                <br><label>Open hours:</label>-->
<!--                <input type="time" id="timePickerS" name="timePickerS" value="10:00" style="width:12%; margin-left: 10px" required>-->
<!--                <label>-</label>-->
<!--                <input type="time" id="timePickerE" name="timePickerE" value="16:00" style="width:12%; margin-left: 10px" required>-->

                <br><label>Brief introduction of the Venue:</label>
                <textarea name="venueInfo" id="venueInfo" style="height:120px;white-space: pre-wrap;" required>A Favourite Community Attraction since the Seventies. Fairfield Showground is renowned as the venue of the Fairfield Markets which have been attracting many thousands of shoppers each weekend since the Seventies. Our markets are the largest in Sydney's West. Friendly Family Fun is the motto of these markets and the fun is guaranteed. Every Saturday from 9AM to 4PM up to 600 undercover stalls are filled with everything from childrens' toys to clothes, sporting gear to jewellery, household items to car accessories, workshop tools to pool products and grocery items to fresh fruit and vege's. While the adults look for the bargains the kids can use up their energy on the jumping castle, carnival rides, merry go round or pony rides. And, when it is time for a relaxing break there are plenty of places to pick up mouth watering kebabs, burgers, Asian delicacies, ice creams, donuts, cold drinks or coffee.
                      </textarea>
            </form>

            <button type="button" class="updateButton" onclick="submitVenue()">UPDATE</button>
        </div>

        <div v-show="currentTab === 'PhotoGallery'" class="tabcontent">
            <span class="photoText">Add photos of Venue to let others have a better knowledge of the Venue:</span>
            <input type="file" id="fileInput" @change="handleFileInputChange($event, 'imageContainer', 8)" accept="image/*" class="photoInput" multiple>
            <div id="imageContainer" class="photoDiv"></div>
            <button type="submit" class="updateButton" onclick="">UPDATE</button>
        </div>

        <div v-show="currentTab === 'StallInformation'" class="tabcontent" style="display: none; font-size: 18px">
            <label style="position: absolute; top:15%; left: 5%">Total stall number:</label>
            <input type="number" placeholder="Enter the total stall number" name="stallNum" class="stallNum">
            <div class="stallForm-setting" >
                <form action="#" class="stall-form">
                    <h5>Add a stall</h5>
                    <label><b>Stall ID</b></label>
                    <input type="text" placeholder="Enter the id for this stall" name="stallID"  required>

                    <label><b>Stall Price</b></label>
                    <input type="text" placeholder="Enter the price for this stall" name="stallPrice" required>

                    <button class="confirmAddStall" action="">Add</button>
                </form>
            </div>
<!--            <span class="photoText" style="top:30%">Add stall distribution map (with stall number):</span>-->
<!--            <input type="file" id="fileInput2" accept="image/*" class="photoInput2" multiple>-->
<!--            <div id="imageContainer2" class="photoDiv2">-->
<!--                <img id="displayImage2" class="displayImage2" src="" alt="Selected Image">-->
<!--                <button id="deleteButton" class="delete-button2" style="display: none;">X</button>-->
<!--            </div>-->
            <button type="submit" class="updateButton" onclick="">UPDATE</button>
        </div>



    </div>
    <!--    <div class="blackLayer" id="layer"></div>-->
</div>



<!--从templates/fragments/footer.html 引入的footer-->
<div th:replace="fragments/footer :: footer"></div>

<!--你可以在下面添加自己想添加的JavaScript-->
<script>
    new Vue({
        el: '#app',
        data: {
            welcome: '',
            currentTab: 'VenueInformation'
        },
        methods: {
            changeTab(tabName) {
                this.currentTab = tabName;
            },
            welcomeMsg() {
                axios.get('/api/users/getCurrentUserInfo') // Make sure the URL is correct
                    .then(response => {
                        this.welcome = response.data;
                    })
                    .catch(error => {
                        this.error = "Error fetching welcome message.";
                        console.error("Error fetching welcome message:", error);
                    });
            },
            handleFileInputChange(e, containerId, maxImages = Infinity) {
                const files = e.target.files;
                const imageContainer = document.getElementById(containerId);
                let imageCount = imageContainer.querySelectorAll('.displayed-image').length;

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];

                    if (imageCount >= maxImages) {
                        alert('Maximum of ' + maxImages + ' photos reached.');
                        break;
                    }

                    const imageElement = document.createElement('div');
                    imageElement.classList.add('image-wrapper');

                    const img = document.createElement('img');
                    img.classList.add('displayed-image');

                    const deleteButton = document.createElement('button');
                    deleteButton.classList.add('delete-button');
                    deleteButton.textContent = 'X';

                    const reader = new FileReader();

                    reader.onload = (event) => {
                        img.src = event.target.result;
                    };

                    reader.readAsDataURL(file);

                    deleteButton.addEventListener('click', () => {
                        imageContainer.removeChild(imageElement);
                        imageCount--;
                    });

                    imageElement.appendChild(img);
                    imageElement.appendChild(deleteButton);
                    imageContainer.appendChild(imageElement);
                    imageCount++;
                }
            },
            handleSingleFileInputChange(e, imageId, deleteButtonId) {
                const file = e.target.files[0];
                const displayImage = document.getElementById(imageId);
                const deleteButton = document.getElementById(deleteButtonId);

                if (file) {
                    const reader = new FileReader();

                    reader.onload = (event) => {
                        displayImage.src = event.target.result;
                        displayImage.style.display = 'block';
                        deleteButton.style.display = 'inline-block';
                    };

                    reader.readAsDataURL(file);
                }
            },
            handleDeleteSingleImage(imageId, deleteButtonId, inputId) {
                const displayImage = document.getElementById(imageId);
                const fileInput = document.getElementById(inputId);
                const deleteButton = document.getElementById(deleteButtonId);

                displayImage.src = '';
                fileInput.value = '';
                deleteButton.style.display = 'none';
                displayImage.style.display = 'none';
            }
        },
        mounted() {
            this.welcomeMsg();
            // Initialization or API call if needed
        }
    });
</script>
<script>
    var venue = {};
    function initAutocomplete() {
        const input = document.getElementById('addressInput');
        const autocomplete = new google.maps.places.Autocomplete(input);

        autocomplete.addListener('place_changed', function() {
            const place = autocomplete.getPlace();
            if (!place.geometry) {
                alert("No details available for input: '" + place.name + "'");
                return;
            }

            const latitude = place.geometry.location.lat();
            const longitude = place.geometry.location.lng();

            console.log('Latitude:', latitude);
            console.log('Longitude:', longitude);
            venue.latitude = latitude;
            venue.longitude = longitude;
            getPlaceDetails(place.place_id);
        });
    }

    function getPlaceDetails(placeId) {
        var input = document.getElementById('addressInput');
        var service = new google.maps.places.PlacesService(input);

        service.getDetails({
            placeId: placeId
        }, function(place, status) {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                const address = extractAddressDetails(place);
                venue.state = address.state;
                venue.street = address.street;
                venue.suburb = address.suburb;
            }
        });
    }

    function extractAddressDetails(place) {
        var state = "";
        var street = "";
        var suburb = "";

        for (var i = 0; i < place.address_components.length; i++) {
            var component = place.address_components[i];
            var types = component.types;

            if (types.indexOf('administrative_area_level_1') !== -1) {
                state = component.long_name;
            }

            if (types.indexOf('street_number') !== -1) {
                street = component.long_name;
            }

            if (types.indexOf('route') !== -1) {
                street += ' ' + component.long_name;
            }

            if (types.indexOf('locality') !== -1 ||
                types.indexOf('sublocality') !== -1 ||
                types.indexOf('sublocality_level_1') !== -1) {
                suburb = component.long_name;
            }
        }

        return {
            state: state,
            street: street.trim(),  // Trim to ensure no leading/trailing spaces
            suburb: suburb
        };
    }

    function submitVenue(){
        venue.venueName = $('#venueName').val();
        venue.description = $('#venueInfo').val();
        axios.post('/api/venues', venue) // Make sure the URL is correct
            .then(response => {
                console.log(response);
                alert("Venue added to DB.");
            })
            .catch(error => {
                alert("Venue update failed.");
            });
    }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD-QTHpG5rvbPs5uE2QE7ucfGeXbU1g_hE&libraries=places&callback=initAutocomplete"></script>
</body>
</html>